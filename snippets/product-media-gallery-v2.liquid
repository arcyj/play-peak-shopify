{% comment %}
  Renders a product media gallery
  Desktop: Images stacked vertically
  Mobile: Slider gallery with thumbnails at the bottom

  Accepts:
  - product: {Object} Product liquid object
  - variant_images: {Array} Product images associated with a variant (optional)
  - limit: {Number} (optional) When passed, limits the number of media items to render

  Usage:
  {% render 'product-media-gallery-v2' %}
{% endcomment %}

{%- liquid
  assign media_count = product.media.size
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
  assign media_width = 1.0
  assign media_fit = 'contain'
-%}

{%- style -%}
  #MediaGallery-{{ section.id }} .product-media-container {
    width: 100% !important;
    display: block;
  }
  #MediaGallery-{{ section.id }} .product-media-container .media {
    width: 100% !important;
  }
{%- endstyle -%}

<media-gallery
  id='MediaGallery-{{ section.id }}'
  role='region'
  class='tw-relative'
  aria-label='{{ 'products.product.media.gallery_viewer' | t }}'
>
  <div id='GalleryStatus-{{ section.id }}' class='tw-sr-only' role='status'></div>

  <div class='tw-relative tw-bg-white desktop:tw-p-16 tablet:tw-p-32'>
    {%- comment -%} Badges {%- endcomment -%}
    <div class='tw-absolute tw-z-50 tw-top-16 tw-right-16'>
      {% render 'on-sale-badge', product: product, class: 'tw-top-0' %}
      {% if product.metafields.custom.product_badge %}
        {% for badge in product.metafields.custom.product_badge.value %}
          {% render 'badge', label: badge.label, variant: badge.variant, class: '' %}
        {% endfor %}
      {% endif %}
    </div>

    {%- comment -%} Desktop: Vertical Stack {%- endcomment -%}
    <div class='tw-hidden desktop:tw-block tw-w-full'>
      <div class='tw-w-full'>
        <ul class='tw-flex tw-flex-col tw-gap-16 tw-list-none tw-m-0 tw-p-0' role='list'>
          {%- if featured_media -%}
            <li
              id='Slide-{{ section.id }}-{{ featured_media.id }}'
              class='tw-w-full'
              data-media-id='{{ section.id }}-{{ featured_media.id }}'
            >
              <div class='tw-w-full'>
                {% render 'product-thumbnail',
                  media: featured_media,
                  media_count: media_count,
                  position: 1,
                  desktop_layout: 'stacked',
                  mobile_layout: 'slider',
                  modal_id: section.id,
                  xr_button: true,
                  media_width: media_width,
                  media_fit: media_fit,
                  lazy_load: true
                %}
              </div>
            </li>
          {%- endif -%}
          {%- for media in product.media -%}
            {%- unless media.id == featured_media.id -%}
              <li
                id='Slide-{{ section.id }}-{{ media.id }}'
                class='tw-w-full'
                data-media-id='{{ section.id }}-{{ media.id }}'
              >
                <div class='tw-w-full'>
                  {%
                    render 'product-thumbnail',
                    media: media,
                    media_count: media_count,
                    position: forloop.index | plus: 1,
                    desktop_layout: 'stacked',
                    mobile_layout: 'slider',
                    modal_id: section.id,
                    xr_button: true,
                    media_width: media_width,
                    media_fit: media_fit,
                    lazy_load: true
                  %}
                </div>
              </li>
            {%- endunless -%}
          {%- endfor -%}
        </ul>
      </div>
    </div>

    {%- comment -%} Mobile: Slider with Bottom Thumbnails {%- endcomment -%}
    {%- if media_count > 1 -%}
      <div class='desktop:tw-hidden tw-w-full'>
        {%- comment -%} Main Slider {%- endcomment -%}
        <slider-component
          id='GalleryViewer-{{ section.id }}'
          class='slider-mobile-gutter tw-w-full tw-mb-16'
        >
          <a class='tw-sr-only quick-add-hidden' href='#ProductInfo-{{ section.id }}'>
            {{ 'accessibility.skip_to_product_info' | t }}
          </a>
          <ul
            id='Slider-Gallery-{{ section.id }}'
            class='tw-list-none tw-m-0 tw-p-0 slider slider--mobile tw-flex'
            role='list'
          >
            {%- if featured_media -%}
              <li
                id='Slide-{{ section.id }}-{{ featured_media.id }}'
                class='tw-w-full tw-flex-shrink-0 slider__slide is-active'
                data-media-id='{{ section.id }}-{{ featured_media.id }}'
              >
                <div class='tw-w-full'>
                  {% render 'product-thumbnail',
                    media: featured_media,
                    media_count: media_count,
                    position: 1,
                    desktop_layout: 'stacked',
                    mobile_layout: 'slider',
                    modal_id: section.id,
                    xr_button: true,
                    media_width: media_width,
                    media_fit: media_fit,
                    lazy_load: true,
                    image_container_class: 'tw-bg-light-gray tw-rouneded-md'
                  %}
                </div>
              </li>
            {%- endif -%}
            {%- for media in product.media -%}
              {%- unless media.id == featured_media.id -%}
                <li
                  id='Slide-{{ section.id }}-{{ media.id }}'
                  class='tw-w-full tw-flex-shrink-0 slider__slide'
                  data-media-id='{{ section.id }}-{{ media.id }}'
                >
                  <div class='tw-w-full'>
                    {%
                      render 'product-thumbnail',
                      media: media,
                      media_count: media_count,
                      position: forloop.index | plus: 1,
                      desktop_layout: 'stacked',
                      mobile_layout: 'slider',
                      modal_id: section.id,
                      xr_button: true,
                      media_width: media_width,
                      media_fit: media_fit,
                      lazy_load: true,
                      image_container_class: 'tw-bg-light-gray tw-rouneded-md'
                    %}
                  </div>
                </li>
              {%- endunless -%}
            {%- endfor -%}
          </ul>
        </slider-component>

        {%- comment -%} Bottom Thumbnails {%- endcomment -%}
        <slider-component
          id='GalleryThumbnails-{{ section.id }}'
          class='slider-mobile-gutter tw-w-full'
        >
          <ul
            id='Slider-Thumbnails-{{ section.id }}'
            class='tw-list-none tw-m-0 tw-p-0 tw-flex tw-gap-12 tw-overflow-x-auto'
            role='list'
          >
            {%- if featured_media -%}
              <li
                id='Slide-Thumbnails-{{ section.id }}-0'
                class='tw-flex-shrink-0'
                data-target='{{ section.id }}-{{ featured_media.id }}'
              >
                <button
                  class='tw-w-20 tw-h-20 tw-relative tw-border-2 tw-border-transparent tw-rounded tw-overflow-hidden tw-cursor-pointer hover:tw-opacity-80 tw-transition-opacity'
                  aria-label='{{ 'products.product.media.load_image' | t: index: 1 }}'
                  aria-current='true'
                  aria-controls='GalleryViewer-{{ section.id }}'
                >
                  {{
                    featured_media.preview_image
                    | image_url: width: 160
                    | image_tag:
                      loading: 'lazy',
                      width: 80,
                      height: 80,
                      alt: featured_media.alt,
                      class: 'tw-w-full tw-h-full tw-object-cover'
                  }}
                </button>
              </li>
            {%- endif -%}
            {%- for media in product.media -%}
              {%- unless media.id == featured_media.id -%}
                <li
                  id='Slide-Thumbnails-{{ section.id }}-{{ forloop.index }}'
                  class='tw-flex-shrink-0'
                  data-target='{{ section.id }}-{{ media.id }}'
                >
                  <button
                    class='tw-w-20 tw-h-20 tw-relative tw-border-2 tw-border-transparent tw-rounded tw-overflow-hidden tw-cursor-pointer hover:tw-opacity-80 tw-transition-opacity'
                    aria-label='{%- if media.media_type == 'image' -%}{{ 'products.product.media.load_image' | t: index: forloop.index | plus: 1 }}{%- elsif media.media_type == 'model' -%}{{ 'products.product.media.load_model' | t: index: forloop.index | plus: 1 }}{%- elsif media.media_type == 'video' or media.media_type == 'external_video' -%}{{ 'products.product.media.load_video' | t: index: forloop.index | plus: 1 }}{%- endif -%}'
                    {% if media == featured_media or featured_media == null and forloop.index == 1 %}
                      aria-current='true'
                    {% endif %}
                    aria-controls='GalleryViewer-{{ section.id }}'
                  >
                    {{
                      media.preview_image
                      | image_url: width: 160
                      | image_tag:
                        loading: 'lazy',
                        width: 80,
                        height: 80,
                        alt: media.alt,
                        class: 'tw-w-full tw-h-full tw-object-cover'
                    }}
                    {%- if media.media_type == 'model' -%}
                      <span class='tw-absolute tw-top-1 tw-right-1 tw-z-10' aria-hidden='true'>
                        <span class='tw-w-4 tw-h-4'>
                          {{- 'icon-3d-model.svg' | inline_asset_content -}}
                        </span>
                      </span>
                    {%- elsif media.media_type == 'video' or media.media_type == 'external_video' -%}
                      <span class='tw-absolute tw-top-1 tw-right-1 tw-z-10' aria-hidden='true'>
                        <span class='tw-w-4 tw-h-4'>
                          {{- 'icon-play.svg' | inline_asset_content -}}
                        </span>
                      </span>
                    {%- endif -%}
                  </button>
                </li>
              {%- endunless -%}
            {%- endfor -%}
          </ul>
        </slider-component>
      </div>
    {%- else -%}
      {%- comment -%} Single Media (Mobile) {%- endcomment -%}
      <div class='desktop:tw-hidden tw-w-full'>
        <div class='tw-w-full'>
          {%- if featured_media -%}
            {% render 'product-thumbnail',
              media: featured_media,
              media_count: media_count,
              position: 1,
              desktop_layout: 'stacked',
              mobile_layout: 'slider',
              modal_id: section.id,
              xr_button: true,
              media_width: media_width,
              media_fit: media_fit,
              lazy_load: true
            %}
          {%- endif -%}
        </div>
      </div>
    {%- endif -%}
  </div>
</media-gallery>
